diff --git a/node_modules/ai/dist/index.js b/node_modules/ai/dist/index.js
index 5cebc15..a4466e1 100644
--- a/node_modules/ai/dist/index.js
+++ b/node_modules/ai/dist/index.js
@@ -12689,12 +12689,26 @@ var AbstractChat = class {
           () => job({
             state: activeResponse.state,
             write: () => {
-              var _a22;
               this.setStatus({ status: "streaming" });
-              const replaceLastMessage = activeResponse.state.message.id === ((_a22 = this.lastMessage) == null ? void 0 : _a22.id);
-              if (replaceLastMessage) {
+              const streamMsgId = activeResponse.state.message.id;
+              const lastId = this.lastMessage == null ? void 0 : this.lastMessage.id;
+              const replaceIndex = messageId != null
+                ? this.state.messages.findIndex((m) => m.id === messageId)
+                : streamMsgId === lastId
+                  ? this.state.messages.length - 1
+                  : -1;
+              if (typeof console !== "undefined" && console.log) {
+                console.log("[ComfyAssistant] chat write", {
+                  messageId,
+                  streamMsgId: streamMsgId == null ? void 0 : streamMsgId.slice(0, 24),
+                  lastId: lastId == null ? void 0 : lastId.slice(0, 24),
+                  replaceIndex,
+                  action: replaceIndex >= 0 ? "replace" : "push"
+                });
+              }
+              if (replaceIndex >= 0) {
                 this.state.replaceMessage(
-                  this.state.messages.length - 1,
+                  replaceIndex,
                   activeResponse.state.message
                 );
               } else {
diff --git a/node_modules/ai/dist/index.mjs b/node_modules/ai/dist/index.mjs
index 71cc912..739f81c 100644
--- a/node_modules/ai/dist/index.mjs
+++ b/node_modules/ai/dist/index.mjs
@@ -12654,12 +12654,26 @@ var AbstractChat = class {
           () => job({
             state: activeResponse.state,
             write: () => {
-              var _a22;
               this.setStatus({ status: "streaming" });
-              const replaceLastMessage = activeResponse.state.message.id === ((_a22 = this.lastMessage) == null ? void 0 : _a22.id);
-              if (replaceLastMessage) {
+              const streamMsgId = activeResponse.state.message.id;
+              const lastId = this.lastMessage == null ? void 0 : this.lastMessage.id;
+              const replaceIndex = messageId != null
+                ? this.state.messages.findIndex((m) => m.id === messageId)
+                : streamMsgId === lastId
+                  ? this.state.messages.length - 1
+                  : -1;
+              if (typeof console !== "undefined" && console.log) {
+                console.log("[ComfyAssistant] chat write", {
+                  messageId,
+                  streamMsgId: streamMsgId == null ? void 0 : streamMsgId.slice(0, 24),
+                  lastId: lastId == null ? void 0 : lastId.slice(0, 24),
+                  replaceIndex,
+                  action: replaceIndex >= 0 ? "replace" : "push"
+                });
+              }
+              if (replaceIndex >= 0) {
                 this.state.replaceMessage(
-                  this.state.messages.length - 1,
+                  replaceIndex,
                   activeResponse.state.message
                 );
               } else {
diff --git a/node_modules/ai/src/ui/chat.ts b/node_modules/ai/src/ui/chat.ts
index 04d0077..ef7115e 100644
--- a/node_modules/ai/src/ui/chat.ts
+++ b/node_modules/ai/src/ui/chat.ts
@@ -503,6 +503,10 @@ export abstract class AbstractChat<UI_MESSAGE extends UIMessage> {
         errorText: string;
       }) =>
     this.jobExecutor.run(async () => {
+      console.log('[ComfyAssistant] addToolOutput called', {
+        toolCallId,
+        status: this.status,
+      });
       const messages = this.state.messages;
       const lastMessage = messages[messages.length - 1];
 
@@ -531,6 +535,9 @@ export abstract class AbstractChat<UI_MESSAGE extends UIMessage> {
         this.status !== 'submitted' &&
         this.sendAutomaticallyWhen
       ) {
+        console.log(
+          '[ComfyAssistant] sendAutomaticallyWhen: will check and maybe makeRequest',
+        );
         this.shouldSendAutomatically().then(shouldSend => {
           if (shouldSend) {
             // no await to avoid deadlocking
@@ -582,6 +589,7 @@ export abstract class AbstractChat<UI_MESSAGE extends UIMessage> {
     trigger: 'submit-message' | 'resume-stream' | 'regenerate-message';
     messageId?: string;
   } & ChatRequestOptions) {
+    console.log('[ComfyAssistant] makeRequest called', { trigger, messageId });
     this.setStatus({ status: 'submitted', error: undefined });
 
     const lastMessage = this.lastMessage;
@@ -648,12 +656,30 @@ export abstract class AbstractChat<UI_MESSAGE extends UIMessage> {
               // streaming is set on first write (before it should be "submitted")
               this.setStatus({ status: 'streaming' });
 
-              const replaceLastMessage =
-                activeResponse.state.message.id === this.lastMessage?.id;
+              // When messageId was passed (follow-up after tool), replace the message with that id
+              // so we append to the same assistant bubble instead of pushing a new one.
+              const streamMsgId = activeResponse.state.message.id;
+              const lastId = this.lastMessage?.id;
+              const replaceIndex =
+                messageId != null
+                  ? this.state.messages.findIndex((m) => m.id === messageId)
+                  : streamMsgId === lastId
+                    ? this.state.messages.length - 1
+                    : -1;
+
+              if (typeof console !== 'undefined' && console.log) {
+                console.log('[ComfyAssistant] chat write', {
+                  messageId,
+                  streamMsgId: streamMsgId?.slice(0, 24),
+                  lastId: lastId?.slice(0, 24),
+                  replaceIndex,
+                  action: replaceIndex >= 0 ? 'replace' : 'push',
+                });
+              }
 
-              if (replaceLastMessage) {
+              if (replaceIndex >= 0) {
                 this.state.replaceMessage(
-                  this.state.messages.length - 1,
+                  replaceIndex,
                   activeResponse.state.message,
                 );
               } else {
